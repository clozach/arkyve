#!/usr/bin/env fish

function find_archive_dir -a start_dir
    # First check current directory for Archive/Archives
    for dir in "Archive" "Archives"
        if test -d "$start_dir/$dir"
            echo "$start_dir/$dir"
            return 0
        end
    end

    # Then check parent directory if not in root
    set parent_dir (dirname "$start_dir")
    if test "$parent_dir" != "$start_dir"
        for dir in "Archive" "Archives"
            if test -d "$parent_dir/$dir"
                echo "$parent_dir/$dir"
                return 0
            end
        end
    end

    # If no archive found, create one in current directory
    set archive_dir "$start_dir/Archive"
    mkdir -p "$archive_dir"
    echo "$archive_dir"
    return 0
end

# Check if any file arguments are provided
if test (count $argv) -lt 1
    echo "Usage: arkyve <file1> [<file2> ...]"
    exit 1
end

# Process each file
for file in $argv
    # Check if file exists
    if not test -f "$file"
        echo "Error: File '$file' not found"
        continue
    end

    # Find or create archive directory
    set archive_dir (find_archive_dir (pwd))

    # Move file to archive
    mv "$file" "$archive_dir/"

    # Confirm move
    echo "Moved '$file' to $archive_dir"
end
